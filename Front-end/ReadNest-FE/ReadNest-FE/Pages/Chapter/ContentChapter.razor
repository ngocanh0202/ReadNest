@using ReadNest_Models
@using ReadNest_FE.Components.DisplayContent
@using ReadNest_FE.Utils
@using ReadNest_FE.Components.Editor
@using ReadNest_FE.Components.ToggleModeSwitch
@using ReadNest_FE.Models
@layout LayoutForReader
@inject ReadNest_FE.Store.Store Store
@inject IJSRuntime Js
@inject ReadNest_FE.Interfaces.IChapterService ChapterService
@inject ReadNest_FE.Interfaces.IBookmarkService BookmarkService
@inject ReadNest_FE.Interfaces.IContentService ContentService
@inject ReadNest_FE.Interfaces.IReadingHistoryService ReadingHistoryService
@inject ReadNest_FE.Services.UiEventService UiEventService
@page "/chapter/{Id}"

<PageTitle>@(currentChapter?.ChapterName ?? "Chapter")</PageTitle>

<div class="flex flex-col justify-center">
    @if (currentChapter is not null)
    {
        <div class="reader-chapter">
            <div class="title !line-clamp-6">@currentChapter.VolumnName</div>
            <div class="sub-title !line-clamp-10">@currentChapter.ChapterName</div>
            <div class="sub-p">
                Length: @lenghWords words – Updated: @timeAgo
            </div>
        </div>
    }   
    <div class="reader-text mb-4 mt-[2rem]!">
        @if (Contents is not null && Contents.Any())
        {
            @foreach (var c in Contents)
            {
                if (!string.IsNullOrEmpty(c.ImageId))
                {
                    <p>
                        <img src="@c.ImageUrl" />
                    </p>
                }
                else
                {
                    <div class="relative content">
                        <p class="!px-2" 
                           @onclick="() => ShowBtnForContent(c.Id)"
                        >
                            @((MarkupString)c.P!)
                        </p>

                        @if (visibleContentId == c.Id)
                        {
                            <div class="absolute top-[-30px] right-0 flex gap-1">
                                <button class="btn-icon text-xl"
                                        @onclick="@(() => ShowModal(c))"
                                        title="Edit content">
                                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9.24264 18.9967H21V20.9967H3V16.754L12.8995 6.85453L17.1421 11.0972L9.24264 18.9967ZM14.3137 5.44032L16.435 3.319C16.8256 2.92848 17.4587 2.92848 17.8492 3.319L20.6777 6.14743C21.0682 6.53795 21.0682 7.17112 20.6777 7.56164L18.5563 9.68296L14.3137 5.44032Z"></path></svg>
                                </button>
                                <button class="btn-icon text-xl"
                                        @onclick="@(async (e) => await OnBookmarkClick(c))"
                                        title="Add bookmark">
                                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" height="1em" width="1em">
                                        <path d="M0 512V48C0 21.49 21.49 0 48 0h288c26.51 0 48 21.49 48 48v464L192 400 0 512z"></path>
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                }
            }
        }
    </div>
</div>

@code {

    // SETTING //
    [Parameter] public string? Id { get; set; }
    [CascadingParameter] private LayoutForReader? Layout { get; set; }
    Response<DetailChapter>? response;
    DetailChapter? detailChapter;
    ChapterOverview? currentChapter;
    string? lenghWords;
    string? timeAgo;
    private string? visibleContentId;
    List<Content>? Contents { get; set; }

    private System.Timers.Timer? pressTimer;
    private readonly double holdTime = 450;
    private Content? editingContent;
    private Action<string>? onSetContent;

    protected override async Task OnInitializedAsync()
    {
        await OnLoadChapter();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            if (Layout != null)
            {
                if (Layout is not null)
                {
                    Layout.OnNotifyChangeChapter -= OnChangeChapter;
                    Layout.OnNotifyChangeChapter += OnChangeChapter;
                }
            }
        }
    }

    private void ShowBtnForContent(string? contentId)
    {
        if (visibleContentId == contentId)
            visibleContentId = null;
        else
            visibleContentId = contentId;
    }

    private async Task OnBookmarkClick(Content content)
    {
        try
        {
            var bookmark = new Bookmark
            {
                NovelId = currentChapter?.NovelId,
                ChapterId = Id,
                ContentText = content.P,     
            };

            var result = await BookmarkService.Post(bookmark);

            if (result != null && result.Success)
            {
                Layout?.ShowAlert("Bookmark saved.", "success");
                visibleContentId = null;
            }
            else
            {
                Layout?.ShowAlert(result?.Message ?? "Failed to save bookmark.", "error");
            }
        }
        catch (Exception ex)
        {
            Layout?.ShowAlert(ex.Message, "error");
        }
    }

    async Task OnLoadChapter()
    {
        try
        {
            response = await ChapterService.GetDetailChapterById(Id!);
            if (response?.Success == true && response.Data is not null)
            {
                detailChapter = response.Data;

                if (detailChapter?.Contents is not null)
                {
                    Contents = detailChapter?.Contents;
                }
                currentChapter = detailChapter?.CurrentChapter;
                lenghWords = Utils.GetLengthWords(detailChapter?.Contents!);
                var updateDate = currentChapter?.UpdateDate;
                if (updateDate.HasValue)
                {
                    timeAgo = Utils.GetTimeAgo(updateDate.Value);
                }
                Layout?.LoadChapters(
                    detailChapter?.CurrentChapter?.NovelId!,
                    detailChapter?.CurrentChapter?.Id!,
                    detailChapter?.NextChapter?.Id!,
                    detailChapter?.PrevChapter?.Id!
                );

                await ReadingHistoryService.Post(new ReadingHistory
                {
                    NovelId = currentChapter?.NovelId!,
                    VolumnId = currentChapter?.VolumnId!,
                    ChapterId = Id!,
                });

                await UpdateReadingHistoryLocal();
            }
        }
        catch(Exception ex)
        {
            Layout?.ShowAlert(ex.Message, "error");
        }
        finally
        {
            if (!string.IsNullOrEmpty(Store.ContentIdValue))
            {
                await Task.Delay(50);
                await Js.InvokeVoidAsync("reader.scrollToText", Store.ContentIdValue, ".content");
                Store.ContentIdValue = null;
            }
            else
            {
                await Js.InvokeVoidAsync("reader.scrollToSelector", ".reader-chapter");
            }
        }
    }

    private async Task UpdateReadingHistoryLocal()
    {
        if (currentChapter is null)
            return;

        Store.readingHistories ??= new List<ReadingHistoryDto>();

        var existing = Store.readingHistories.FirstOrDefault(x => x.NovelId == currentChapter.NovelId && x.ChapterId == Id);
        if (existing != null)
        {
            Store.readingHistories.Remove(existing);
            Store.readingHistories.Insert(0, existing);
            await Js.InvokeVoidAsync(
                "localStorage.setItem",
                "readingHistories",
                System.Text.Json.JsonSerializer.Serialize(Store.readingHistories)
            );
        }
        else
        {
            await ReadingHistoryService.Get();
        }
    }

    async void OnChangeChapter(string newChapterId)
    {
        Id = newChapterId;
        await OnLoadChapter();
    }

    private void StartPress(Content p)
    {
        if (Store.HasContributePermission == null || !Store.HasContributePermission.Value)
            return;
        pressTimer?.Stop();

        pressTimer = new System.Timers.Timer(holdTime);
        pressTimer.Elapsed += (_, __) =>
        {
            InvokeAsync(() => ShowModal(p));
            pressTimer?.Stop();
        };
        pressTimer.AutoReset = false;
        pressTimer.Start();
    }

    private void EndPress()
    {
        pressTimer?.Stop();
    }

    private void ShowModal(Content content)
    {
        if (Store.HasContributePermission == null || !Store.HasContributePermission.Value)
            return;
        editingContent = content;
        string newP = content.P ?? string.Empty;
        Layout?.ShowModal(
            null!,
            @<div class="space-y-4">
                <Editor @bind-content="newP"></Editor>
            </div>
            ,
            EventCallback.Factory.Create(this, () => HandleToUpdateContent(newP)),
            confirmText: "Update content",
            showCancel: false,
            showOk: true
        );
        UiEventService?.OnSetContent?.Invoke(newP);
    }

    private async Task HandleToUpdateContent(string? newP)
    {
        if (string.IsNullOrWhiteSpace(newP))
        {
            Layout?.ShowAlert("Content cannot be empty.", "error");
            return;
        }

        if (editingContent != null)
        {
            editingContent.P = newP;

            var contentInList = Contents?.FirstOrDefault(c => c.Id == editingContent.Id);
            if (contentInList != null)
            {
                contentInList.P = newP;
            }

            StateHasChanged();
            await InvokeAsync(StateHasChanged);
            await ContentService.PutValue(contentInList!);

            editingContent = null;
        }
    }

    public void Dispose()
    {
        pressTimer?.Dispose();
        if (Layout != null)
        {
            Layout.OnNotifyChangeChapter -= OnChangeChapter;
        }
    }
}
