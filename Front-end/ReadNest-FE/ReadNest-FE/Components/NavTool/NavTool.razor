@using ReadNest_FE.Components.InputSearch
@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject ReadNest_FE.Router.Router Router
@inject ReadNest_FE.Store.Store Store
@inject ReadNest_FE.Interfaces.IAuthService AuthService

<nav class="main-nav @(isNavVisible ? "visible" : "hidden")">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="@Router.HomeUrl" class="brand-link">
                <svg class="brand-icon-svg" viewBox="0 0 24 24" fill="none">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>ReadNest</span>
            </a>
        </div>

        <div class="nav-menu">
            <button @onclick="HandleSave" class="tool-btn-action btn-save" title="Save changes">
                <svg class="action-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Save</span>
            </button>
            <button @onclick="HandleAddVolume" class="tool-btn-action btn-add" title="Add new volume">
                <svg class="action-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <line x1="12" y1="9" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <line x1="9" y1="12" x2="15" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                <span>Add Volume</span>
            </button>
            <button @onclick="HandleDelete" class="tool-btn-action btn-delete" title="Delete novel">
                <svg class="action-icon" viewBox="0 0 24 24" fill="none">
                    <polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                <span>Delete</span>
            </button>
            <div class="theme-toggle-wrapper">
                <input type="checkbox" id="theme-toggle" @onchange="ToggleTheme" checked="@isDarkMode" />
                <label for="theme-toggle" class="toggle-label">
                    <span class="toggle-slider">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" />
                            <path d="M12 1v6m0 6v6m11-11h-6m-6 0H1m16.5 9l-4.2-4.2M6.7 6.7l-4.2-4.2m0 14.2l4.2-4.2m10.6 0l4.2 4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                </label>
            </div>
            <a class="nav-link" @onclick="Logout">
                <svg class="logout-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M19 12H9m10 0-3-3m3 3-3 3"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </a>
        </div>

        <button class="mobile-menu-btn" @onclick="ToggleMobileMenu">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>

    </div>
    <div class="mobile-menu @(isMobileMenuOpen ? "open" : "")">
        <button @onclick="() => { ToggleMobileMenu(); HandleSave(); }" class="tool-btn-action btn-save mobile">
            <svg class="action-icon" viewBox="0 0 24 24" fill="none">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>Save</span>
        </button>
        <button @onclick="() => { ToggleMobileMenu(); HandleAddVolume(); }" class="tool-btn-action btn-add mobile">
            <svg class="action-icon" viewBox="0 0 24 24" fill="none">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <line x1="12" y1="9" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <line x1="9" y1="12" x2="15" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <span>Add Volume</span>
        </button>
        <button @onclick="() => { ToggleMobileMenu(); HandleDelete(); }" class="tool-btn-action btn-delete mobile">
            <svg class="action-icon" viewBox="0 0 24 24" fill="none">
                <polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <span>Delete</span>
        </button>

        <div class="theme-toggle-wrapper mobile">
            <span class="theme-label">Theme</span>
            <input type="checkbox" id="theme-toggle-mobile" @onchange="ToggleTheme" checked="@isDarkMode" />
            <label for="theme-toggle-mobile" class="toggle-label">
                <span class="toggle-slider">
                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" />
                        <path d="M12 1v6m0 6v6m11-11h-6m-6 0H1m16.5 9l-4.2-4.2M6.7 6.7l-4.2-4.2m0 14.2l4.2-4.2m10.6 0l4.2 4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </span>
            </label>
        </div>
        <a class="nav-link flex" @onclick="Logout">
            <svg class="logout-icon" viewBox="0 0 24 24" fill="none">
                <path d="M15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M19 12H9m10 0-3-3m3 3-3 3"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>Logout</span>
        </a>
    </div>
</nav>

@code {
    [CascadingParameter] public MainLayoutForAuthor? Layout { get; set; }
    // =====================
    // 🪟 Nav management
    // =====================
    private bool isNavVisible = true;
    private bool isMobileMenuOpen = false;
    private bool isDarkMode = true;
    private double hoverThreshold = 100;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (JS != null)
            {
                isDarkMode = await JS.InvokeAsync<bool>("themeToggle.initialize");
                StateHasChanged();
            }
        }
    }

    [JSInvokable]
    public void OnScroll(double scrollY, bool isScrollingUp, bool isNearTop)
    {
        bool shouldShow = isScrollingUp || isNearTop;

        if (isNavVisible != shouldShow)
        {
            isNavVisible = shouldShow;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnMouseMove(double mouseY)
    {
        if (mouseY < hoverThreshold && !isNavVisible)
        {
            isNavVisible = true;
            StateHasChanged();
        }
    }

    private void HandleSave()
    {
        try
        {
            Layout?.OnClickOnSave?.Invoke();    
        }
        catch (Exception ex)
        {
            Layout?.ShowAlert($"Error deleting: {ex.Message}", "error");
        }
    }

    private void HandleAddVolume()
    {
        try
        {
            Layout?.OnClickOnAddNewVolumn?.Invoke();
        }
        catch (Exception ex)
        {
            Layout?.ShowAlert($"Error deleting: {ex.Message}", "error");
        }
    }

    private void HandleDelete()
    {
        try
        {
            Layout?.OnClickOnDelete?.Invoke();
        }
        catch (Exception ex)
        {
            Layout?.ShowAlert($"Error deleting: {ex.Message}", "error");
        }
    }

    private void ToggleMobileMenu()
    {
        isMobileMenuOpen = !isMobileMenuOpen;
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        await JS.InvokeVoidAsync("themeToggle.setTheme", isDarkMode ? "dark" : "light");
    }

    public async void Logout()
    {
        await AuthService.Logout();
    }
}
